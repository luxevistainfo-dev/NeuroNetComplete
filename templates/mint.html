{% extends "base.html" %}

{% block title %}Mint NFT{% endblock %}

{% block content %}
<div class="card">
    <h1><i class="fas fa-plus-circle"></i> Mint AI NFT</h1>
    <p class="subtitle">Create your own AI NFT with built-in neural network</p>
    
    <div id="walletRequired" class="alert alert-warning" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        Please <a href="#" onclick="openWalletModal()">connect your wallet</a> to mint NFTs.
    </div>
    
    <div id="mintForm" style="display: none;">
        <div class="form-group">
            <label for="nftName">NFT Name *</label>
            <input type="text" id="nftName" placeholder="Enter a unique name for your AI NFT" maxlength="50">
            <small>Name will be shown on your NFT (1-50 characters)</small>
        </div>
        
        <div class="nft-preview">
            <div class="preview-header">
                <h3 id="previewName">My AI NFT</h3>
                <span class="preview-id">New NFT</span>
            </div>
            <div class="preview-body">
                <div class="preview-row">
                    <span>Owner:</span>
                    <span id="previewOwner">Your Address</span>
                </div>
                <div class="preview-row">
                    <span>Value:</span>
                    <span class="value" id="previewValue">1.00 NN</span>
                </div>
                <div class="preview-row">
                    <span>Intelligence:</span>
                    <span id="previewIntelligence">1.00</span>
                </div>
                <div class="preview-row">
                    <span>Neural Network:</span>
                    <span class="status active">Ready to Learn</span>
                </div>
            </div>
        </div>
        
        <button id="mintBtn" class="btn btn-primary" style="width: 100%; padding: 15px; font-size: 18px;">
            <i class="fas fa-magic"></i> Mint NFT (Cost: 1 NN)
        </button>
    </div>
</div>

<div class="card">
    <h2><i class="fas fa-robot"></i> Your NFTs</h2>
    <div id="myNFTsContainer">
        <p class="text-muted">Connect wallet to see your NFTs</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    checkWalletForMint();
    
    // Update preview as user types
    const nameInput = document.getElementById('nftName');
    if (nameInput) {
        nameInput.addEventListener('input', function() {
            document.getElementById('previewName').textContent = this.value || 'My AI NFT';
        });
    }
    
    // Mint button
    const mintBtn = document.getElementById('mintBtn');
    if (mintBtn) {
        mintBtn.addEventListener('click', mintNFT);
    }
});

function checkWalletForMint() {
    const walletRequired = document.getElementById('walletRequired');
    const mintForm = document.getElementById('mintForm');
    
    if (currentWallet) {
        walletRequired.style.display = 'none';
        mintForm.style.display = 'block';
        
        // Update preview with wallet address
        const shortAddr = currentWallet.substring(0, 10) + '...' + currentWallet.substring(currentWallet.length - 6);
        document.getElementById('previewOwner').textContent = shortAddr;
        
        // Load user's NFTs
        loadUserNFTs();
    } else {
        walletRequired.style.display = 'block';
        mintForm.style.display = 'none';
    }
}

async function mintNFT() {
    const name = document.getElementById('nftName').value.trim();
    
    if (!name) {
        showNotification('Please enter a name for your NFT', 'error');
        return;
    }
    
    if (name.length < 1 || name.length > 50) {
        showNotification('Name must be 1-50 characters', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/mint-nft', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ name: name })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`NFT "${name}" minted successfully!`, 'success');
            document.getElementById('nftName').value = '';
            document.getElementById('previewName').textContent = 'My AI NFT';
            loadUserNFTs();
            updateNetworkStats();
        } else {
            showNotification(data.error || 'Failed to mint NFT', 'error');
        }
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
    }
}

async function loadUserNFTs() {
    if (!currentWallet) return;
    
    try {
        const response = await fetch('/api/get-nfts');
        const data = await response.json();
        
        const container = document.getElementById('myNFTsContainer');
        
        if (data.nfts && data.nfts.length > 0) {
            let html = '<div class="nfts-grid">';
            
            data.nfts.forEach(nft => {
                html += `
                    <div class="nft-item">
                        <div class="nft-header">
                            <h4>${nft.name}</h4>
                            <span class="nft-value">${nft.value} NN</span>
                        </div>
                        <div class="nft-body">
                            <div class="nft-stat">
                                <span>Intelligence:</span>
                                <span>${nft.intelligence}</span>
                            </div>
                            <div class="nft-stat">
                                <span>Difficulty:</span>
                                <span>${nft.difficulty}</span>
                            </div>
                            <div class="nft-stat">
                                <span>Created:</span>
                                <span>${new Date(nft.created_at * 1000).toLocaleDateString()}</span>
                            </div>
                            <button onclick="location.href='/train'" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
                                <i class="fas fa-robot"></i> Train
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p class="text-muted">You have no NFTs yet. Mint your first one above!</p>';
        }
    } catch (error) {
        console.error('Error loading NFTs:', error);
        document.getElementById('myNFTsContainer').innerHTML = '<p class="text-muted">Error loading NFTs</p>';
    }
}
</script>

<style>
.nft-preview {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
    border: 2px dashed rgba(102, 126, 234, 0.5);
}

.preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.preview-id {
    background: rgba(0,0,0,0.3);
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 12px;
    color: var(--gray);
}

.preview-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.preview-row:last-child {
    border-bottom: none;
}

.preview-row .value {
    color: #28a745;
    font-weight: bold;
}

.status.active {
    color: #28a745;
}

.nfts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.nft-item {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    padding: 15px;
    border: 1px solid rgba(255,255,255,0.1);
    transition: transform 0.3s;
}

.nft-item:hover {
    transform: translateY(-5px);
    border-color: rgba(102, 126, 234, 0.5);
}

.nft-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.nft-header h4 {
    margin: 0;
    font-size: 18px;
}

.nft-value {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
    padding: 3px 8px;
    border-radius: 5px;
    font-weight: bold;
}

.nft-stat {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    font-size: 14px;
}

.nft-stat:first-child {
    color: var(--primary);
}
</style>
{% endblock %}
