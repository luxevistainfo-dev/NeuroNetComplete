{% extends "base.html" %}

{% block title %}NeuroNet - Train AI{% endblock %}

{% block content %}
<div class="card">
    <h1><i class="fas fa-robot"></i> Train Your AI NFT</h1>
    <p class="lead">Improve your NFT's intelligence through conversation. Each training session increases value and earns rewards.</p>
    
    <div id="walletCheck" class="alert warning" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        Please <a href="#" onclick="openWalletModal()">connect a wallet</a> to train NFTs.
    </div>
    
    <div id="trainInterface" style="display: none;">
        <div class="grid grid-3">
            <div class="card">
                <h3><i class="fas fa-list"></i> Select NFT</h3>
                <div id="nftSelector">
                    <!-- NFTs will be loaded here -->
                </div>
            </div>
            
            <div class="card" style="grid-column: span 2;">
                <h3><i class="fas fa-comments"></i> Training Chat</h3>
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message bot">
                            <div class="message-header">
                                <i class="fas fa-robot"></i> AI Assistant
                            </div>
                            <div class="message-content">
                                Hello! I'm your AI assistant. Select an NFT and start chatting to train it!
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input">
                        <input type="text" id="chatInput" placeholder="Type your message here..." disabled>
                        <button id="sendButton" class="btn-primary" disabled>
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                    
                    <div class="training-stats">
                        <div class="stat">
                            <span class="stat-label">Cooldown:</span>
                            <span class="stat-value" id="cooldownTimer">Ready</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Next Reward:</span>
                            <span class="stat-value" id="nextReward">0.00 NN</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-3">
            <div class="card">
                <h3><i class="fas fa-chart-line"></i> Current NFT Stats</h3>
                <div id="currentStats">
                    <div class="alert info">
                        Select an NFT to see stats
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-history"></i> Training History</h3>
                <div id="trainingHistory" class="training-history">
                    <!-- Training history will appear here -->
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-gem"></i> Mining Rewards</h3>
                <div class="mining-info">
                    <p>Each training session:</p>
                    <ul>
                        <li>Increases NFT value</li>
                        <li>Improves neural network</li>
                        <li>Earns NN tokens</li>
                        <li>Contributes to network</li>
                    </ul>
                    <div class="current-reward">
                        <h4>Current Session Reward:</h4>
                        <div class="reward-amount" id="currentReward">0.00 NN</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedNFT = null;
let trainingCooldown = false;
let cooldownEndTime = 0;

document.addEventListener('DOMContentLoaded', function() {
    checkWalletForTraining();
    setupChat();
    updateCooldownTimer();
    
    // Update cooldown timer every second
    setInterval(updateCooldownTimer, 1000);
});

function checkWalletForTraining() {
    const walletCheck = document.getElementById('walletCheck');
    const trainInterface = document.getElementById('trainInterface');
    
    if (currentWallet) {
        walletCheck.style.display = 'none';
        trainInterface.style.display = 'block';
        loadNFTsForTraining();
    } else {
        walletCheck.style.display = 'block';
        trainInterface.style.display = 'none';
    }
}

function setupChat() {
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !trainingCooldown) {
            sendTrainingMessage();
        }
    });
    
    sendButton.addEventListener('click', sendTrainingMessage);
}

async function loadNFTsForTraining() {
    try {
        const response = await fetch('/api/get-nfts');
        const data = await response.json();
        
        const nftSelector = document.getElementById('nftSelector');
        nftSelector.innerHTML = '';
        
        if (data.nfts && data.nfts.length > 0) {
            data.nfts.forEach(nft => {
                const nftOption = document.createElement('div');
                nftOption.className = 'nft-option';
                nftOption.innerHTML = `
                    <div class="nft-option-header">
                        <h4>${nft.name}</h4>
                        <span class="nft-value">${nft.value.toFixed(2)} NN</span>
                    </div>
                    <div class="nft-option-details">
                        <span>Intelligence: ${nft.intelligence.toFixed(2)}</span>
                        <span>Difficulty: ${nft.difficulty.toFixed(2)}</span>
                    </div>
                `;
                
                nftOption.addEventListener('click', () => selectNFT(nft));
                nftSelector.appendChild(nftOption);
            });
            
            // Select first NFT by default
            selectNFT(data.nfts[0]);
        } else {
            nftSelector.innerHTML = `
                <div class="alert info">
                    <i class="fas fa-info-circle"></i>
                    You don't have any NFTs. <a href="/mint-page">Mint one first!</a>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading NFTs:', error);
    }
}

function selectNFT(nft) {
    selectedNFT = nft;
    
    // Highlight selected NFT
    document.querySelectorAll('.nft-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
    // Update stats display
    updateNFTStats(nft);
    
    // Update training history
    updateTrainingHistory(nft);
    
    // Enable chat
    document.getElementById('chatInput').disabled = false;
    document.getElementById('sendButton').disabled = false;
    
    // Update reward estimate
    updateRewardEstimate(nft);
    
    // Add welcome message
    addChatMessage('bot', `Selected NFT: ${nft.name}. Ready to train! Send me a message and I'll learn from it.`);
}

function updateNFTStats(nft) {
    const statsDiv = document.getElementById('currentStats');
    statsDiv.innerHTML = `
        <div class="nft-stats">
            <div class="stat-row">
                <span>Name:</span>
                <span><strong>${nft.name}</strong></span>
            </div>
            <div class="stat-row">
                <span>Value:</span>
                <span class="stat-value">${nft.value.toFixed(2)} NN</span>
            </div>
            <div class="stat-row">
                <span>Intelligence:</span>
                <span class="stat-value">${nft.intelligence.toFixed(2)}</span>
            </div>
            <div class="stat-row">
                <span>Difficulty:</span>
                <span class="stat-value">${nft.difficulty.toFixed(2)}</span>
            </div>
            <div class="stat-row">
                <span>Last Training:</span>
                <span>${nft.last_train ? formatTime(nft.last_train) : 'Never'}</span>
            </div>
            <div class="stat-row">
                <span>Neural Network:</span>
                <span>${nft.neural_network ? 'Active' : 'Inactive'}</span>
            </div>
        </div>
    `;
}

function updateTrainingHistory(nft) {
    const historyDiv = document.getElementById('trainingHistory');
    
    if (nft.training_history && nft.training_history.length > 0) {
        let historyHTML = '';
        // Show last 5 trainings
        const recentTrainings = nft.training_history.slice(-5).reverse();
        
        recentTrainings.forEach(training => {
            const messagePreview = training.message.length > 30 
                ? training.message.substring(0, 30) + '...' 
                : training.message;
            
            historyHTML += `
                <div class="history-item">
                    <div class="history-message">"${messagePreview}"</div>
                    <div class="history-details">
                        <span class="history-error">Error: ${training.error.toFixed(4)}</span>
                        <span class="history-time">${formatTime(training.timestamp)}</span>
                    </div>
                </div>
            `;
        });
        
        historyDiv.innerHTML = historyHTML;
    } else {
        historyDiv.innerHTML = `
            <div class="alert info">
                No training history yet. Start chatting!
            </div>
        `;
    }
}

function updateRewardEstimate(nft) {
    const baseReward = 0.1;
    const difficultyBonus = nft.difficulty * 0.05;
    const intelligenceBonus = nft.intelligence * 0.01;
    const totalReward = baseReward + difficultyBonus + intelligenceBonus;
    
    document.getElementById('currentReward').textContent = totalReward.toFixed(2) + ' NN';
    document.getElementById('nextReward').textContent = totalReward.toFixed(2) + ' NN';
}

async function sendTrainingMessage() {
    if (!selectedNFT || trainingCooldown) return;
    
    const chatInput = document.getElementById('chatInput');
    const message = chatInput.value.trim();
    
    if (!message) {
        showNotification('Please enter a message', 'warning');
        return;
    }
    
    // Add user message to chat
    addChatMessage('user', message);
    
    // Clear input
    chatInput.value = '';
    
    try {
        // Send training request
        const response = await fetch('/api/train-nft', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                nft_id: selectedNFT.id,
                message: message
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Add bot response
            const botMessage = `Training successful! Value increased by ${(data.training_result.new_value - selectedNFT.value).toFixed(2)}. ` +
                              `Error: ${data.training_result.error.toFixed(4)}. Reward: ${data.reward} NN`;
            addChatMessage('bot', botMessage);
            
            // Set cooldown (30 seconds)
            trainingCooldown = true;
            cooldownEndTime = Date.now() + 30000; // 30 seconds
            
            // Update NFT data
            selectedNFT.value = data.training_result.new_value;
            selectedNFT.difficulty = data.nft.difficulty;
            selectedNFT.intelligence = data.nft.intelligence;
            selectedNFT.last_train = data.nft.last_train;
            
            // Update stats
            updateNFTStats(selectedNFT);
            updateRewardEstimate(selectedNFT);
            
            // Show notification
            showNotification(`Training successful! Earned ${data.reward} NN`, 'success');
            
            // Update wallet info
            fetchWalletInfo();
        } else {
            addChatMessage('bot', `Training failed: ${data.error}`);
            showNotification(data.error, 'error');
        }
    } catch (error) {
        addChatMessage('bot', `Error: ${error.message}`);
        showNotification('Training error: ' + error.message, 'error');
    }
}

function addChatMessage(sender, message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    
    messageDiv.className = `message ${sender}`;
    messageDiv.innerHTML = `
        <div class="message-header">
            <i class="fas fa-${sender === 'user' ? 'user' : 'robot'}"></i>
            ${sender === 'user' ? 'You' : 'AI Assistant'}
        </div>
        <div class="message-content">${message}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function updateCooldownTimer() {
    if (!trainingCooldown) return;
    
    const now = Date.now();
    const remaining = cooldownEndTime - now;
    
    if (remaining <= 0) {
        trainingCooldown = false;
        document.getElementById('cooldownTimer').textContent = 'Ready';
        document.getElementById('chatInput').disabled = false;
        document.getElementById('sendButton').disabled = false;
    } else {
        const seconds = Math.ceil(remaining / 1000);
        document.getElementById('cooldownTimer').textContent = `${seconds}s`;
        document.getElementById('chatInput').disabled = true;
        document.getElementById('sendButton').disabled = true;
    }
}
</script>

<style>
.nft-option {
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s;
    border: 1px solid transparent;
}

.nft-option:hover {
    background: rgba(255,255,255,0.08);
    border-color: rgba(102, 126, 234, 0.3);
}

.nft-option.selected {
    background: rgba(102, 126, 234, 0.2);
    border-color: rgba(102, 126, 234, 0.8);
}

.nft-option-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.nft-option-header h4 {
    margin: 0;
    font-size: 16px;
}

.nft-value {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: bold;
}

.nft-option-details {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: rgba(255,255,255,0.7);
}

.chat-container {
    height: 400px;
    display: flex;
    flex-direction: column;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: rgba(0,0,0,0.3);
    border-radius: 10px;
    margin-bottom: 15px;
}

.message {
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 10px;
    max-width: 80%;
}

.message.user {
    background: rgba(102, 126, 234, 0.2);
    margin-left: auto;
    border: 1px solid rgba(102, 126, 234, 0.5);
}

.message.bot {
    background: rgba(108, 117, 125, 0.2);
    margin-right: auto;
    border: 1px solid rgba(108, 117, 125, 0.5);
}

.message-header {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
    margin-bottom: 5px;
    font-size: 12px;
    color: rgba(255,255,255,0.8);
}

.message-content {
    font-size: 14px;
    line-height: 1.4;
}

.chat-input {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.chat-input input {
    flex: 1;
    padding: 12px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 10px;
    color: white;
}

.training-stats {
    display: flex;
    justify-content: space-between;
    background: rgba(0,0,0,0.3);
    padding: 10px 15px;
    border-radius: 10px;
}

.stat {
    display: flex;
    gap: 10px;
}

.stat-label {
    color: rgba(255,255,255,0.7);
}

.stat-value {
    font-weight: bold;
    color: #ffc107;
}

.nft-stats {
    padding: 10px;
}

.stat-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.stat-row:last-child {
    border-bottom: none;
}

.stat-value {
    color: #28a745;
    font-weight: bold;
}

.training-history {
    max-height: 200px;
    overflow-y: auto;
}

.history-item {
    background: rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 8px;
    border-left: 3px solid #667eea;
}

.history-message {
    font-style: italic;
    margin-bottom: 5px;
    color: rgba(255,255,255,0.9);
}

.history-details {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: rgba(255,255,255,0.6);
}

.history-error {
    color: #ffc107;
}

.mining-info ul {
    padding-left: 20px;
    margin: 15px 0;
}

.mining-info li {
    margin-bottom: 8px;
    color: rgba(255,255,255,0.8);
}

.current-reward {
    text-align: center;
    padding: 15px;
    background: rgba(40, 167, 69, 0.1);
    border-radius: 10px;
    border: 1px solid rgba(40, 167, 69, 0.3);
}

.reward-amount {
    font-size: 24px;
    font-weight: bold;
    color: #28a745;
    margin-top: 10px;
}
</style>
{% endblock %}
